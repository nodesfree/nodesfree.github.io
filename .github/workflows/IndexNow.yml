name: IndexNow Submission

# è§¦å‘æ¡ä»¶ï¼šå½“å†…å®¹æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
on:
  push:
    branches:
      - main
    paths-ignore:
      # å¿½ç•¥ä¸åŒ…å«å†…å®¹æ›´æ”¹çš„æ–‡ä»¶ï¼Œæé«˜æ•ˆç‡
      - 'README.md'
      - '.github/**'

jobs:
  submit_indexnow:
    runs-on: ubuntu-latest
    
    # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
    env:
      INDEXNOW_HOST: nodesfree.github.io
      # ä» Secrets ä¸­è·å–å¯†é’¥
      INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
      # å¯†é’¥æ–‡ä»¶çš„ä½ç½®
      INDEXNOW_KEY_LOCATION: https://nodesfree.github.io/${{ secrets.INDEXNOW_KEY }}.txt

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          # ä»…è·å–æœ€è¿‘çš„ä¸¤æ¬¡æäº¤ï¼Œç”¨äºæ¯”è¾ƒå“ªäº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–
          fetch-depth: 2

      # -------------------------------------------------------------
      # ğŸ’¡ æ ¸å¿ƒæ­¥éª¤ï¼šæ‰¾å‡ºæœ¬æ¬¡æäº¤ä¸­æ–°å¢æˆ–ä¿®æ”¹çš„ .md æˆ– .html æ–‡ä»¶
      # -------------------------------------------------------------
      - name: ğŸ” Find changed files
        id: changed-files
        # ä½¿ç”¨ git diff è·å–åœ¨å½“å‰æäº¤å’Œå‰ä¸€ä¸ªæäº¤ä¹‹é—´å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶çš„åˆ—è¡¨
        run: |
          # è·å–ä¿®æ”¹å’Œæ–°å¢çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶è¿‡æ»¤å‡º markdown/html æ–‡ä»¶
          CHANGED_URLS=$(git diff --name-only HEAD^ HEAD | grep -E '\.(md|html)$' | while read FILE; do
            # å‡è®¾æ‚¨çš„æ–‡ä»¶è·¯å¾„èƒ½æ˜ å°„åˆ° URL è·¯å¾„
            # è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹è½¬æ¢ï¼Œæ‚¨å¯èƒ½éœ€è¦æ ¹æ®æ‚¨çš„é™æ€ç”Ÿæˆå™¨è°ƒæ•´
            # 1. ç§»é™¤æ–‡ä»¶æ‰©å±•å (.md, .html)
            # 2. æ›¿æ¢æ–‡ä»¶è·¯å¾„åˆ†éš”ç¬¦ '/' ä¸º URL è·¯å¾„
            # 3. åŠ ä¸Šå®Œæ•´çš„ host
            
            # ç®€åŒ–çš„ URL è½¬æ¢é€»è¾‘ (ç¤ºä¾‹: _posts/hello.md -> https://host/posts/hello)
            URL_PATH=$(echo "$FILE" | sed -E 's/\.(md|html)$//' | sed 's/^_//')
            echo "https://${{ env.INDEXNOW_HOST }}/$URL_PATH/"
          done)
          
          # å°†æ‰¾åˆ°çš„ URL åˆ—è¡¨è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          echo "URL_LIST_RAW=$CHANGED_URLS" >> $GITHUB_OUTPUT
          echo "Found URLs: $CHANGED_URLS"

      - name: ğŸš§ Check if URLs were found
        run: |
          if [ -z "${{ steps.changed-files.outputs.URL_LIST_RAW }}" ]; then
            echo "No relevant URLs changed. Skipping IndexNow submission."
            exit 0
          fi
          
      - name: ğŸ“¦ Format URL List to JSON Array
        id: format-json
        run: |
          # å°†åŸå§‹ URL å­—ç¬¦ä¸²è½¬æ¢ä¸º JSON æ•°ç»„æ ¼å¼
          URL_LIST_JSON=$(echo "${{ steps.changed-files.outputs.URL_LIST_RAW }}" | tr '\n' ',' | sed 's/,$//' | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          echo "URL_LIST_JSON=$URL_LIST_JSON" >> $GITHUB_OUTPUT
          echo "JSON Payload URL List: $URL_LIST_JSON"
        
      # -------------------------------------------------------------
      # ğŸš€ æœ€ç»ˆæ­¥éª¤ï¼šå‘é€ IndexNow POST è¯·æ±‚
      # -------------------------------------------------------------
      - name: ğŸ“¢ Send IndexNow Request
        run: |
          # æ„é€ å®Œæ•´çš„ JSON è¯·æ±‚ä½“
          JSON_PAYLOAD='{
            "host": "${{ env.INDEXNOW_HOST }}",
            "key": "${{ env.INDEXNOW_KEY }}",
            "keyLocation": "${{ env.INDEXNOW_KEY_LOCATION }}",
            "urlList": '${{ steps.format-json.outputs.URL_LIST_JSON }}'
          }'
          
          echo "Sending payload:"
          echo "$JSON_PAYLOAD"
          
          # ä½¿ç”¨ curl å‘é€ POST è¯·æ±‚
          curl -X POST 'https://api.indexnow.org/IndexNow' \
          -H 'Content-Type: application/json; charset=utf-8' \
          -d "$JSON_PAYLOAD"
          
          echo "IndexNow submission complete."
